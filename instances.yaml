#heat_template_version: 2013-05-23
heat_template_version: 2016-04-08

description: Simple template to deploy a single compute instance


parameters:
  stack_name:
    type: string
    label: stack_name 
    description: Name of the stack
    default: basic
  instance_count:
    type: string
    label: instance_count
    description: Number of instance 
    default: 2
  flavor:
    type: string
    label: flavor
    description: Type of instance (flavor) 
    default: 1 GB Performance
  image:
    type: string
    label: image
    description: Type of instance (flavor) 
    default: Ubuntu 16.04 LTS (Xenial Xerus) (PVHVM)
  ssh_key:
    type: string
    label: ssh_key
    description: The ssh key for admin connections
    default: ssh-key
  private_network:
    type: string
    label: Public network name or ID
    description: Public network with floating IP addresses.
    default: private


resources:
  instances:
    type: OS::Heat::ResourceGroup
    properties:
      count: { get_param: instance_count }
      resource_def:
        type: OS::Nova::Server
        properties:
          # create a unique name for each server
          # using its index in the group
          name: 
            str_replace:
              template: stack%_instance_%index%
              params:
                "stack%": { get_param: stack_name }
          image: { get_param: image }
          flavor: { get_param: flavor }
          key_name: { get_param: ssh_key }
          user_data:
          str_replace:
          template: |
            #!/bin/bash -v
              apt-get install docker-engine python python-pip
              pip install docker-compose
              wget ..
              docker-compuse up -d

  cinder_volume:
    type: OS::Cinder::Volume
    properties:
    size: { get_param: volume_size }
  
  volume_attachment:
    type: OS::Cinder::VolumeAttachment
    properties:
      volume_id: { get_resource: cinder_volume }
      instance_uuid: { get_resource: nova_instance }
      mountpoint: /dev/vdc

yum -y install httpd wordpress
sed -i "/Deny from All/d" /etc/httpd/conf.d/wordpress.conf
sed -i "s/Require local/Require all granted/" /etc/httpd/conf.d/wordpress.conf
sed -i s/database_name_here/db_name/ /etc/wordpress/wp-config.php
sed -i s/username_here/db_user/      /etc/wordpress/wp-config.php
sed -i s/password_here/db_password/  /etc/wordpress/wp-config.php
sed -i s/localhost/db_ipaddr/        /etc/wordpress/wp-config.php
setenforce 0 # Otherwise net traffic with DB is disabled
systemctl start httpd.service
params:
db_rootpassword: { get_param: db_root_password }
db_name: { get_param: db_name }
db_user: { get_param: db_username }
db_password: { get_param: db_password }
db_ipaddr: { get_attr: [DatabaseServer, networks, private, 0] }
#          security_groups:
#            - { get_resource: admin_security_group }
#            - { get_resource: web_server_security_group }

